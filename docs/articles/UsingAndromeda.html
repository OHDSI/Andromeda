<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Andromeda • Andromeda</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Andromeda">
<meta property="og:description" content="Andromeda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Andromeda</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/UsingAndromeda.html">Using Andromeda</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link">hadesLogo</a>
</li>
<li>
  <a href="https://github.com/OHDSI/Andromeda/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Andromeda</h1>
                        <h4 data-toc-skip class="author">Martijn J. Schuemie</h4>
            
            <h4 data-toc-skip class="date">2022-01-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Andromeda/blob/HEAD/vignettes/UsingAndromeda.Rmd" class="external-link"><code>vignettes/UsingAndromeda.Rmd</code></a></small>
      <div class="hidden name"><code>UsingAndromeda.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>Andromeda</code> package provides the ability to work with data objects in R that are too large to fit in memory. Instead, these objects are stored on disk. This is slower than working from memory, but may be the only viable option. <code>Andromeda</code> aims to replace the now orphaned <code>ff</code> package.</p>
<div class="section level3">
<h3 id="permanence">Permanence<a class="anchor" aria-label="anchor" href="#permanence"></a>
</h3>
<p>To mimic the behavior of in-memory objects, when working with data in <code>Andromeda</code> the data is stored in a temporary location on the disk. You can modify the data as you can see fit, and when needed can save the data to a permanent location. Later this data can be loaded to a temporary location again and be read and modified, while keeping the saved data as is.</p>
</div>
<div class="section level3">
<h3 id="technology">Technology<a class="anchor" aria-label="anchor" href="#technology"></a>
</h3>
<p><code>Andromeda</code> heavily relies on <code>RSQLite</code>, an R wrapper around SQLite. SQLite is a low-weight but very powerful single-user SQL database that can run from a single file on the local file system. Although SQLite and therefore <code>Andromeda</code> can be queried using SQL, <code>Andromeda</code> favors using <code>dbplyr</code>, a <code>dplyr</code> implementation, to work with the data.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-an-andromeda-object">Creating an Andromeda object<a class="anchor" aria-label="anchor" href="#creating-an-andromeda-object"></a>
</h2>
<p>Creating a empty <code>Andromeda</code> object is easy:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OHDSI/Andromeda" class="external-link">Andromeda</a></span><span class="op">)</span>
<span class="va">andr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/andromeda_constructor.html">andromeda</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We can add new tables to the <code>Andromeda</code> environment like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op">&lt;-</span> <span class="va">cars</span>
<span class="va">andr</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># Andromeda object</span></span>
<span class="co">## <span style="color: #949494;"># Physical location:  /var/folders/xx/01v98b6546ldnm1rg1_bvk000000gn/T//RtmpgHDs3h/file69b15c8c9bb7.sqlite</span></span>
<span class="co">## </span>
<span class="co">## Tables:</span>
<span class="co">## $cars (speed, dist)</span></code></pre>
<p>We could have achieved the same by adding the table when creating the <code>Andromeda</code> object:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/andromeda_constructor.html">andromeda</a></span><span class="op">(</span>cars <span class="op">=</span> <span class="va">cars</span><span class="op">)</span></code></pre></div>
<p>Of course, we probably want to add data to the <code>Andromeda</code> environment that is much larger than can fit in memory. One way to achieve this is by iteratively adding more and more data to the same table. As an example here we simply add the same data to the existing table:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/appendToTable.html">appendToTable</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars</span>, <span class="va">cars</span><span class="op">)</span></code></pre></div>
<p>The data to append should have the same columns as the existing data, or else an error will be thrown.</p>
<p>Data can be copied from one Andromeda to another:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/andromeda_constructor.html">andromeda</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">andr2</span><span class="op">$</span><span class="va">cars</span> <span class="op">&lt;-</span> <span class="va">andr</span><span class="op">$</span><span class="va">cars</span></code></pre></div>
<p>For very large tables this may be slow. A faster option might be to copy the entire <code>Andromeda</code> object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/copyAndromeda.html">copyAndromeda</a></span><span class="op">(</span><span class="va">andr</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="closing-andromeda-objects">Closing Andromeda objects<a class="anchor" aria-label="anchor" href="#closing-andromeda-objects"></a>
</h3>
<p>Every <code>Andromeda</code> object will have a corresponding data file in a temporary location on your local file system. This file will be automatically deleted when the <code>Andromeda</code> object is no longer used. It is best practice not to rely on R to decide when to do this, but explicitly cause the file to be cleaned up by calling the <code>close</code> statement:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">andr</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">andr2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">andr3</span><span class="op">)</span></code></pre></div>
<p>Once an <code>Andromeda</code> is closed the underlying file is deleted, and it can no longer be used. You can check whether an Andromeda object is still valid:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/isValidAndromeda.html">isValidAndromeda</a></span><span class="op">(</span><span class="va">andr</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] FALSE</span></code></pre>
</div>
<div class="section level3">
<h3 id="temporary-file-location">Temporary file location<a class="anchor" aria-label="anchor" href="#temporary-file-location"></a>
</h3>
<p>By default <code>Andromeda</code> uses the default temporary file location of your operating system to store the Andromeda objects while your are working on them. You can override the location by setting the <code>andromedaTempFolder</code> option:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>andromedaTempFolder <span class="op">=</span> <span class="st">"c:/andromedaTemp"</span><span class="op">)</span></code></pre></div>
<p>This only applies to <code>Andromeda</code> objects that are created from that point onward. Prior objects will stay where they are.</p>
</div>
</div>
<div class="section level2">
<h2 id="querying-data-from-an-andromeda-object">Querying data from an Andromeda object<a class="anchor" aria-label="anchor" href="#querying-data-from-an-andromeda-object"></a>
</h2>
<p><code>Andromeda</code> relies on <code>dbplyr</code>, a <code>dplyr</code> implementation, for querying the data. A key aspect of <code>dbplyr</code> is lazy execution. This means that we can define a query, but the query will not be executed until we explicitly request so using the <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> statement. For example, we may want to know the number of cars that can go faster than 10:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/andromeda_constructor.html">andromeda</a></span><span class="op">(</span>cars <span class="op">=</span> <span class="va">cars</span><span class="op">)</span>
<span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1 × 1</span></span>
<span class="co">##       n</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span>    41</span></code></pre>
<p>Here we first filter the table to those rows where <code>speed &gt; 10</code>, after which we count the number of remaining records. This query is not executed until we call <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code>. We can also have <code>Andromeda</code> call <code>collect</code> for us, by assigning the query to a table:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span><span class="op">$</span><span class="va">fastCars</span> <span class="op">&lt;-</span> <span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>This way the query result does not have to pass through memory, but instead is directly stored in Andromeda.</p>
<div class="section level3">
<h3 id="simple-meta-data">Simple meta-data<a class="anchor" aria-label="anchor" href="#simple-meta-data"></a>
</h3>
<p>If we wish to know the tables that exist in an <code>Andromeda</code> object, we can call the generic <code>names</code> function. Similarly, we can call <code>colnames</code> to get the names of the columns in a table:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">andr</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "cars"     "fastCars"</span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "speed" "dist"</span></code></pre>
</div>
<div class="section level3">
<h3 id="using-sql">Using SQL<a class="anchor" aria-label="anchor" href="#using-sql"></a>
</h3>
<p>In the end, an <code>Andromeda</code> is still an <code>RSQLite</code> database, and can be queried using SQL:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">andr</span>, <span class="st">"SELECT * FROM cars LIMIT 5;"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##   speed dist</span>
<span class="co">## 1     4    2</span>
<span class="co">## 2     4   10</span>
<span class="co">## 3     7    4</span>
<span class="co">## 4     7   22</span>
<span class="co">## 5     8   16</span></code></pre>
<p>However, for consistency it is recommended to use the <code>dplyr</code> functions instead.</p>
</div>
<div class="section level3">
<h3 id="dates-and-times">Dates and times<a class="anchor" aria-label="anchor" href="#dates-and-times"></a>
</h3>
<p>One limitation of SQLite - the technology underlying Andromeda - is that it does not support date and time formats. Dates and times are automatically converted to numeric values when adding them to an Andromeda table. Converting them back needs to be done manually:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>someTime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-01 10:00"</span>, 
                                             <span class="st">"2001-01-31 11:00"</span>, 
                                             <span class="st">"2004-12-31 12:00"</span><span class="op">)</span><span class="op">)</span>,
                     someDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-01"</span>, 
                                          <span class="st">"2001-01-31"</span>, 
                                          <span class="st">"2004-12-31"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">andr</span><span class="op">$</span><span class="va">myData</span> <span class="op">&lt;-</span> <span class="va">myData</span>
<span class="va">andr</span><span class="op">$</span><span class="va">myData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>someTime <span class="op">=</span> <span class="fu"><a href="../reference/restorePosixct.html">restorePosixct</a></span><span class="op">(</span><span class="va">someTime</span><span class="op">)</span>,
         someDate <span class="op">=</span> <span class="fu"><a href="../reference/restoreDate.html">restoreDate</a></span><span class="op">(</span><span class="va">someDate</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning: Input to restorePosixct is already Posixct</span></code></pre>
<pre><code><span class="co">## Warning: Input to restoreDate is already a Date.</span></code></pre>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span>
<span class="co">##   someTime            someDate  </span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span>
<span class="co">## <span style="color: #BCBCBC;">1</span> 2000-01-01 <span style="color: #949494;">15:00:00</span> 2000-01-01</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> 2001-01-31 <span style="color: #949494;">16:00:00</span> 2001-01-31</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> 2004-12-31 <span style="color: #949494;">17:00:00</span> 2004-12-31</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="batch-operations">Batch operations<a class="anchor" aria-label="anchor" href="#batch-operations"></a>
</h2>
<p>Often we’ll need to perform some action against the data that is not supported by <code>dplyr.</code> For example, we may want to write to data to a CSV file, or perform some complex computation. Since we cannot assume an entire table (or query result) will fit in memory, we must assume we should do this batch-wise. For this the <code>Andromeda</code> package provides two functions: <code>batchApply</code> and <code>groupApply</code>. The former executes a function on batches of predefined length. We can specify the batch size by setting the <code>batchSize</code> argument, which defaults to 100,000. Here is a silly example, where take the number of rows in a batch, and multiply it by some number:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">doSomething</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span>, <span class="va">multiplier</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">*</span> <span class="va">multiplier</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/batchApply.html">batchApply</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars</span>, <span class="va">doSomething</span>, multiplier <span class="op">=</span> <span class="fl">2</span>, batchSize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="va">result</span></code></pre></div>
<pre><code><span class="co">## [1] 20 20 20 20 20</span></code></pre>
<p>Alternatively, using <code>groupApply</code> we can execute a function on groups of rows, defined by the value in some variable in the table. In this example, we first filter to fast cars, and then perform the same meaningless computation as in the previous example, this time on groups of rows defined by having the same speed:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">doSomething</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span>, <span class="va">multiplier</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">*</span> <span class="va">multiplier</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/groupApply.html">groupApply</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span>, 
                     <span class="va">doSomething</span>, 
                     groupVariable <span class="op">=</span> <span class="st">"speed"</span>, 
                     multiplier <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="va">result</span></code></pre></div>
<pre><code><span class="co">## 11 12 13 14 15 16 17 18 19 20 22 23 24 25 </span>
<span class="co">##  4  8  8  8  6  4  6  8  6 10  2  2  8  2</span></code></pre>
<p>(For example, there were 2 rows where <code>speed = 11</code>, and multiplied by 2 this gives 4 for item 11.)</p>
<div class="section level3">
<h3 id="safe-mode">Safe mode<a class="anchor" aria-label="anchor" href="#safe-mode"></a>
</h3>
<p>For technical reasons it is not possible to write to the same <code>Andromeda</code> while reading from it. Writing to an <code>Andromeda</code> environment while inside a <code>batchApply</code> or <code>groupApply</code> on the that same Andromeda environment will therefore result in an error message. To avoid this, you can set the <code>safe</code> argument to <code>TRUE</code>. This will cause the table to first be copied to a temporary <code>Andromeda</code> before executing the function. However, this might not be very fast:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">doSomething</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">batch</span><span class="op">$</span><span class="va">speedSquared</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">speed</span><span class="op">^</span><span class="fl">2</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">andr</span><span class="op">$</span><span class="va">cars2</span> <span class="op">&lt;-</span> <span class="va">batch</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="fu"><a href="../reference/appendToTable.html">appendToTable</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars2</span>, <span class="va">batch</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="fu"><a href="../reference/batchApply.html">batchApply</a></span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">cars</span>, <span class="va">doSomething</span>, safe <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Note that this only a restriction of <code>batchApply</code> and <code>groupApply</code>. We could have achieved the same task as the example above much faster using only <code>dplyr</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span><span class="op">$</span><span class="va">cars2</span> <span class="op">&lt;-</span>
  <span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>speedSquared <span class="op">=</span> <span class="va">speed</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="saving-and-loading-andromeda-objects">Saving and loading Andromeda objects<a class="anchor" aria-label="anchor" href="#saving-and-loading-andromeda-objects"></a>
</h2>
<p>To reuse an <code>Andromeda</code> at a later point in time, we can save it to a permanent location:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/saveAndromeda.html">saveAndromeda</a></span><span class="op">(</span><span class="va">andr</span>, <span class="st">"c:/temp/andromeda.zip"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Disconnected Andromeda. This data object can no longer be used</span></code></pre>
<p>For technical reasons, saving an Andromeda object closes it. If we want to continue using the Andromeda object, we can set <code>maintainConnection</code> to <code>TRUE</code> when calling <code>saveAndromeda</code>. This causes a temporary copy to be created first, which is then saved and closed. Obviously this will take additional time, so if you know you will no longer need the object in R after saving, it is best not to use this option.</p>
<p>We can load the object again using:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadAndromeda.html">loadAndromeda</a></span><span class="op">(</span><span class="st">"c:/temp/andromeda.zip"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-andromeda-in-your-packages">Using Andromeda in your packages<a class="anchor" aria-label="anchor" href="#using-andromeda-in-your-packages"></a>
</h2>
<p>Andromeda is intended to be used inside of other packages. Here are some tips:</p>
<div class="section level3">
<h3 id="import-dplyr">Import dplyr<a class="anchor" aria-label="anchor" href="#import-dplyr"></a>
</h3>
<p>Make sure <code>dplyr</code> is imported in the NAMESPACE. That way all <code>dplyr</code> functions can be used on the Andromeda objects in your functions.</p>
</div>
<div class="section level3">
<h3 id="import--data-from-rlang">Import .data from rlang<a class="anchor" aria-label="anchor" href="#import--data-from-rlang"></a>
</h3>
<p>If we reference variables in our <code>dplyr</code> function calls we should precede them with <code>.data$</code> to avoid R check warnings about using an unknown variable. For example, instead of</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>we should write</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>to avoid R check warnings about <code>speed</code> being an unknown variable.</p>
</div>
<div class="section level3">
<h3 id="beware-of-variable-name-confusion">Beware of variable name confusion<a class="anchor" aria-label="anchor" href="#beware-of-variable-name-confusion"></a>
</h3>
<p><code>dplyr</code> sometimes confuses variable names, so we have to help. For example, this code:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">speed</span> <span class="op">==</span> <span class="va">speed</span><span class="op">)</span></code></pre></div>
<p>will not actually filter anything, because the second <code>speed</code> variable in the filter statement is interpreted to refer to the <code>speed</code> field in the data, not the variable we defined earlier. One way to avoid this is by forcing early evaluation of the variable:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">andr</span><span class="op">$</span><span class="va">cars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">speed</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">speed</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Adam Black, Martijn Schuemie, Marc A. Suchard.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
